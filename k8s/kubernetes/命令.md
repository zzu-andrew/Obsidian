
## `kubectl`





### `kubectl get`

- 获取 `ConfigMap`类型对象的配置，并按照 `yaml` 形式输出
根据输出的 `mode: ipvs` 可以确定使用的网络负载均衡模式是 `iptables` 还是 `ipvs`
```bash
$ kubectl get configmap kube-proxy -n kube-system -o yaml
```

- 获取一个节点所有的 `yaml` 配置
```bash
$ $kubectl get pod prometheus-k8s-0 -n base-services -o yaml
```
- 获取对应空间中有多少service类型
可以用来查看service类型节点的cluster-ip和端口映射关系。
```bash
$ kubectl get service -n base-services
NAME                    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE
prometheus-k8s          NodePort    10.96.0.184   <none>        9090:30090/TCP  8d
```
- 在获取到service类型之后可以通过一下命令查看对应service的yaml配置
这里的 `prometheus-k8s` 是service name
```bash
$ kubectl get service prometheus-k8s -n base-services -o yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus-k8s
  namespace: base-services
spec:
  clusterIP: 10.96.0.184
  clusterIPs:
  - 10.96.0.184
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  - name: web
    nodePort: 30090
    port: 9090
    protocol: TCP
    targetPort: 9090
  selector:
    app: prometheus
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: kube-prometheus
    prometheus: k8s
  # 会话亲和性，配置了亲和性同一个外部ClientIp在超时之前一直会访问同一个Pod
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  type: NodePort
```
- 获取所有监听类型的Pod资源
```bash
$ kubectl get all -n base-services
```
- 不知道获取空间里面什么具体资源时可以通过 `get all` 获取整个空间的缩略信息
```bash
$ kubectl get all -n base-services
```

- 获取所有命名空间
```bash
$ kubectl get namespaces
```


```bash
# 获取自定义资源类型  
kubectl get crd  
# 获取创建的Service  
kubectl get svc  
# 编辑Service的配置，比如将对应的服务类型修改为NodePort，NodePort只是Service的一种类型  
kubectl edit svc prometheus-k8s 
```  

---
### `kubectl describe` 输出节点的详细信息

- 输出命名空间位`base-services`节点类型为`statefulset`类型节点的详细信息
```bash
$ kubectl describe statefulset prometheus-k8s -n base-services
```


### `kubectl explain`

- 查看 `pod` 节点下对应的 `yaml` 能配置哪些字段以及对应字段的解释说明。
```bash
$ kubectl explain pod.spec.containers
```


### `kubectl logs`

- 查看pod日志
```bash
kubectl logs prometheus-k8s-0 -n moniting
```


### `kubectl top`

- 查看 `prometheus pod` 资源使用情况
```bash
kubectl get pod prometheus-k8s-0 -n moniting
```
- 查看该命令空间下所有 `pod` 的资源使用情况
```bash
kubectl top pod  -n base-services 
```


### `kubectl` 其他命令

- 将pod的端口转发到宿主机
```bash
$ kubectl port-forward -n monitoring service/grafana 3000:80
```
- 编辑Service的配置，比如将对应的服务类型修改为`NodePort，NodePort`只是`Service`的一种类型  
```bash
$ kubectl edit svc prometheus-k8s 
```








### `cAdvisor (Container Advisor)`

可用于查询容器指标的数据

- `container_cpu_usage_seconds_total`: 容器的CPU使用总量。
- `container_memory_usage_bytes`: 容器的内存使用量。
- `container_network_receive_bytes_total`: 容器接收的网络字节数。

- `cpu` 使用统计
pod:container_cpu_usage_seconds_total:sum - 自定义缩写

等价于
max by(pod, node, host_ip, pod_ip, namespace) (max by(pod) (rate(container_cpu_usage_seconds_total{image!="",job="kubelet", node="k8snode-node-03"}[2m]) * 100) * on(pod) group_right() (kube_pod_info))



